#!/bin/sh
# postinst script for igestis-itimer
#
# see: dh_installdeb(1)

package_name=igestis-commercial

. /usr/share/debconf/confmodule


#DEBHELPER#


case "$1" in
    configure)

            if [ -e /etc/igestis/debian-db.php ] ; then

                # On récupère les infos de la base de données.
                dbname=$(cat /etc/igestis/debian-db.php  | grep "\$dbname" | cut -d\' -f2)
                dbuser=$(cat /etc/igestis/debian-db.php  | grep "\$dbuser" | cut -d\' -f2)
                dbpass=$(cat /etc/igestis/debian-db.php  | grep "\$dbpass" | cut -d\' -f2)

                # On vérifie que la structure de mise à jour automatique est bien présente.
                mysql -u$dbuser -p$dbpass $dbname -e 'CREATE TABLE IF NOT EXISTS `MYSQL_UPDATES` (`sql_file` varchar(50) collate utf8_unicode_ci NOT NULL,`date` datetime NOT NULL) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;'

                # On récupère et lance la liste des mises à jour.
		
                ls -v1 /usr/share/dbconfig-common/data/$package_name/install/ | while read i ; do
                    file=$(mysql -u$dbuser -p$dbpass $dbname -e "SELECT sql_file FROM MYSQL_UPDATES WHERE sql_file='$package_name-$i';")
                    if [ -z "$file" ] ; then
                        mysql -u$dbuser -p$dbpass $dbname < /usr/share/dbconfig-common/data/$package_name/install/$i || true
                        mysql -u$dbuser -p$dbpass $dbname -e "INSERT INTO MYSQL_UPDATES (sql_file, \`date\`) VALUES ('$package_name-$i', NOW());"
                    fi
                done

                ls -v1 /usr/share/dbconfig-common/data/$package_name/upgrade/mysql/ | while read i ; do
                    file=$(mysql -u$dbuser -p$dbpass $dbname -e "SELECT sql_file FROM MYSQL_UPDATES WHERE sql_file='$package_name-$i';")
                    if [ -z "$file" ] ; then
                        mysql -u$dbuser -p$dbpass $dbname < /usr/share/dbconfig-common/data/$package_name/upgrade/mysql/$i || true
                        mysql -u$dbuser -p$dbpass $dbname -e "INSERT INTO MYSQL_UPDATES (sql_file, \`date\`) VALUES ('$package_name-$i', NOW());"
                    fi
                done

            fi


	CACHE_FOLDER="/var/cache/igestis/"

	## We setup the cache folder to the right location
	mkdir -p $CACHE_FOLDER
	if [ ! -z "$CACHE_FOLDER" ] ; then rm -rf $CACHE_FOLDER/* ; fi
	invoke-rc.d apache2 reload

        # New script to automatically apply SQL updates.
        php /usr/share/igestis/command.php  databases:update

	## We regenerate the language cache
	php /usr/share/doc/igestis/regenLocales.php /usr/share/igestis
	chown www-data -R $CACHE_FOLDER
	chmod 700 -R $CACHE_FOLDER

	# Setup of Apache2.
	
	mkdir -p /usr/share/igestis/documents/Commercial/
	chown www-data -R /usr/share/igestis/documents/
	chmod 700 -R /usr/share/igestis/documents/


    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0

