#!/bin/sh
# postinst script for igestis-itimer
#
# see: dh_installdeb(1)

package_name=igestis-commercial

. /usr/share/debconf/confmodule

CONFIG="/etc/igestis/config.ini"

get_value_global_vars()
{

grep "^$1[[:space:]]*=.*" $CONFIG | \
  cut -d= -f 2 | \
  cut -d" " -f 2 | \
  sed 's|"||g'

}

CACHE_FOLDER=$(get_value_global_vars CACHE_FOLDER)
DATA_FOLDER=$(get_value_global_vars DATA_FOLDER)

#DEBHELPER#


case "$1" in
    configure)

            if [ -e /etc/igestis/debian-db.php ] ; then

                # On récupère les infos de la base de données.
                dbname=$(cat /etc/igestis/debian-db.php  | grep "\$dbname" | cut -d\' -f2)
                dbuser=$(cat /etc/igestis/debian-db.php  | grep "\$dbuser" | cut -d\' -f2)
                dbpass=$(cat /etc/igestis/debian-db.php  | grep "\$dbpass" | cut -d\' -f2)

                # On vérifie que la structure de mise à jour automatique est bien présente.
                mysql -u$dbuser -p$dbpass $dbname -e 'CREATE TABLE IF NOT EXISTS `MYSQL_UPDATES` (`sql_file` varchar(50) collate utf8_unicode_ci NOT NULL,`date` datetime NOT NULL) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;'

                # On récupère et lance la liste des mises à jour.

                ls -v1 /usr/share/dbconfig-common/data/$package_name/install/ | while read i ; do
                    file=$(mysql -u$dbuser -p$dbpass $dbname -e "SELECT sql_file FROM MYSQL_UPDATES WHERE sql_file='$package_name-$i';")
                    if [ -z "$file" ] ; then
                        mysql -u$dbuser -p$dbpass $dbname < /usr/share/dbconfig-common/data/$package_name/install/$i || true
                        mysql -u$dbuser -p$dbpass $dbname -e "INSERT INTO MYSQL_UPDATES (sql_file, \`date\`) VALUES ('$package_name-$i', NOW());"
                    fi
                done

                ls -v1 /usr/share/dbconfig-common/data/$package_name/upgrade/mysql/ | while read i ; do
                    file=$(mysql -u$dbuser -p$dbpass $dbname -e "SELECT sql_file FROM MYSQL_UPDATES WHERE sql_file='$package_name-$i';")
                    if [ -z "$file" ] ; then
                        mysql -u$dbuser -p$dbpass $dbname < /usr/share/dbconfig-common/data/$package_name/upgrade/mysql/$i || true
                        mysql -u$dbuser -p$dbpass $dbname -e "INSERT INTO MYSQL_UPDATES (sql_file, \`date\`) VALUES ('$package_name-$i', NOW());"
                    fi
                done

            fi



	## We setup the cache folder to the right location
	mkdir -p $CACHE_FOLDER
	if [ ! -z "$CACHE_FOLDER" ] ; then rm -rf $CACHE_FOLDER/* ; fi
	invoke-rc.d apache2 reload

	## Maintenances scripts
	php /usr/share/igestis/command.php i18n:regen-locales
	php /usr/share/igestis/command.php databases:update

	# Fix cache rights
	chown www-data -R $CACHE_FOLDER
	chmod 700 -R $CACHE_FOLDER

	# Create data folder
	mkdir -p $DATA_FOLDER/Commercial/invoices
	mkdir -p $DATA_FOLDER/Commercial/providersInvoices
	mkdir -p $DATA_FOLDER/Commercial/quotations
	mkdir -p $DATA_FOLDER/Commercial/freeDocuments
	mkdir -p $DATA_FOLDER/Commercial/interventions

	chown www-data -R $DATA_FOLDER
	chmod 700 -R $DATA_FOLDER

	# Remove setup install
	rm -rf /usr/share/igestis/install

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
